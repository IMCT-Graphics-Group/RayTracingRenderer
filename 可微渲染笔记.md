# 1. 微分光线传播的蒙特卡洛估计

为了支持可微渲染，正向的渲染积分过程被改造得面目全非，本篇论文的主要目的就是将可微渲染从正向渲染积分过程中解耦出来，避免其对正向渲染算法的影响。

这种解耦的方案实在是太多了：是只对蒙特卡洛估计求解导数，还是对采样方法求解导数？重要性采样应该应用在求解导数之前还是之后？专门的可微采样策略还需要用吗？当数百万参数同时求解导数时，可见性不连续的问题该如何解决？本篇论文是有关可微光线传播的不同蒙特卡洛估计方法的分类和分析的讨论。

过去的三维重建和逆向问题大多是基于特定需求和假设的前提下设计的解决方案。比如CT扫描重建就假设了被扫描对象是吸收X光线的，如果其中有金属之类对X光产生较多反射的材料，就会严重影响重建算法，在最终得到的图像中也会出现大量的伪影。

结构光重建技术在遇到镜面物体把特定光照图案反射到其他位置时，也会严重影响其重建的效果。

整体上来说，图片的信息非常复杂，包含形状、相互作用、光照、材质等信息，还有很多的间接信息，比如阴影、反射等，将场景中不同的物体都耦合到一起。照在物体表面的聚光灯效果可能会被当成纹理，光源或者来自于其他物体的反射。要想解决这些不确定性，就需要结合使用多种不同的观察和重建技术，考察光线传播和散射过程中的作用效果。

本篇论文介绍可微渲染的数学理论基础，以此说明逆向问题的实质是一类高维空间的梯度优化问题。数百万的场景参数包含了光照、形状、材质等信息，场景参数的导数信息解耦了场景中的辐射度信息，提供了高维空间中最速上升的方向，为解决逆向问题贡献了不可多得的关键信息。

目前来说，可微渲染算法的创造遵循非常固定的步骤：可微首先被纳入求解光线传播积分的标准方法中（如路径追踪），其中可能会增加一些额外的步骤来解决可见性不连续问题；然后，对积分问题的可微被推广到更通用的计算中，或手动求解，或使用自动微分器求解。

虽然这种步骤创造出来的算法基本都是有效的，但是会从根本上改变底层的积分过程。场景参数可能会非常敏感，一个很小的扰动就会导致积分渲染结果产生很大的变动，然后根据蒙特卡洛算法的原理，就需要投放相应比例的采样数到这些区域以达到更快的收敛。但是，这种方法在可微渲染算法中是无法轻易实现的，因为可微渲染算法都是从某个固定的正向渲染过程中导出的；最坏的情况下，这些敏感的区域在正向渲染过程中甚至可能会被丢弃，从而使得可微算法产生偏差。

有一种被称为“辐射度反向传播”的算法将可微渲染推广到反向传播中，从传感器向物体传播辐射度的可微参数。该方法解耦了正向积分和可微估计，是我们工作的起点。虽然该解耦算法提供了很大的自由度，但仍然表现出其对可微渲染本质的不了解，本篇论文将从以下方面介绍如何设计可微光线传播估计算法：

- 采用重要性采样的蒙特卡洛估计通常都会使用逆向方法，将均匀分布改造成目标分布。如果要设计可微的蒙特卡洛估计，这种改造既可以保持不变，也可以使得它可微起来；这两种方案我们分别称为“独立策略”和“依附策略”。独立策略使用静态采样数，依附策略则根据参数的变化而调整采样数。
- 采样策略一般不单独使用，通常会使用“多重重要性采样”的框架。根据不同的方案，多重重要性采样的权重既可以保持原样，也可以根据参数变化调整。
- 采样策略是用于近似实际的积分分布形状的，但无论使用哪种方案，这种近似都可能会随着可微化而失效。这种情况下就需要设计专门的策略来适配新的积分形状，我们称这种策略为“可微策略”。我们会为微表面模型给出一种可微策略，并且分析论证使用这种策略的优势。
- 可见性不连续的问题仍然需要谨慎对待。我们会介绍一些技术绕开这个问题，从而得以应用辐射度反向传播技术和几何优化方法。
- 并不是所有方案都互相兼容的，有些独立或依附的多重重要性采样和一些独立或依附的采样策略得到的是有偏估计，有些依附策略采样会影响不连续积分的处理。
- 最后，渲染方法经常使用各种各样的随机方法，包括中止路径追踪的俄罗斯轮盘赌和对BSDF的采样。我们会证明这些随机方法不应当可微化，否则会严重影响结果的无偏性。

对蒙特卡洛模拟求导曾经被用于建模核反应的临界条件，也曾被用于对组织细胞进行逆向建模，这类方法被称为“摄动蒙特卡洛法”或者“可微蒙特卡洛法”。

渲染中使用导数来计算纹理滤波、梯度域的渲染、自适应采样和重建、非漫反射全局光照等。具有高光或者靠近高光的光路常给渲染带来很多难题，路径求导提供了高效搜索和外推的方案。

可微渲染在计算视觉领域也有很多的应用。逆向渲染是计算视觉领域的一个基本问题，之前已经有大量工作研究了图像处理过程的微分方法。一些间接的效果，如阴影、间接反射、景深等，在过去并不是这类研究中的重点内容，相关工作主要集中在对于网格和体积的可微光栅化方法的可见性问题上。

计算机图形学中的可微渲染。基于物理的可微渲染计算了关于场景参数的偏导数。

间接效果在优化材质中尤为重要，比如具有显著多次散射特征的参与介质。早期的基于物理的可微渲染依赖于正向可微渲染来传递一些导数信息，这需要对每一个目标参数额外地跑一遍计算；后来的反向可微渲染可以一次性计算出所有的场景参数导数。

反向可微渲染的广泛使用极大地提高了大量参数求导的速度，但同样带来了一些问题：导数计算需要得到原始计算的中间步骤，并且该顺序与原始程序的执行顺序相反。如果没有临时存储的原始变量，是无法逆转程序的，而这些需要临时存储的数据量非常庞大。

**辐射度反向传播**（radiative backpropagation）算法给出了这样一种解决方案，它意识到，反向传播可以当作求解辐射度传播的偏导数，这个偏导数由相机发射、场景物体散射，最终被含有可微参数的物体接收。由此，可微渲染过程可以被拆解为两个阶段用以处理复杂的高分辨率场景。*具体一点，先进行一次正向的渲染，根据渲染结果求解目标参数的伴随敏感度；然后将伴随敏感度反向传播（像辐射度渲染一样）回去，就可以得到参数导数。*

***

**独立采样策略**（Detached sampling strategies）该方法的灵感来自于手动求解常微分方程的过程，是一种解析解法，不关心数值结果。该方法简单地移动了偏导数的位置并在积分下求导：

$\part_\pi I=\part_\pi [\int_\chi f(\textbf{x},\pi)\textrm{d\textbf{x}}]=\int_\chi \part_\pi f(\textbf{x}.\pi)\textrm{d\textbf{x}}$

如果不存在非连续问题，那么这种变换是没有问题的。它也适用于非连续性是静态的情况，也就是与$\pi$无关时。

*重用性采样*：鉴于大部分光线传输的积分方程都会使用带有重要性采样的蒙特卡洛方法求解，那么解决重要性采样的可微就是必要的。考虑一组微分同胚$T:U\rightarrow X$，目标域$X$由$n$维单位超立方体$U=[0,1]^n$参数化。映射关系$\textbf{x}=T(\textbf{u})$由目标密度函数$p(\textbf{x})$构造，则其雅可比行列式满足$\abs{J(\textbf{u})}=p(\textbf{x})^{-1}$，重新调整一下原始的积分式可以得到：

$I=\int_U f(T(\textbf{u}))\abs{J(\textbf{u})}\textrm{d\textbf{u}}=\int_U \frac{f(T(\textbf{u}))}{p(T(\textbf{u}))}\textrm{d\textbf{u}}$

对其进行微分：

$\part_\pi I=\int_U\frac{\part_\pi f(T(\textbf{u}))}{p(T(\textbf{u}))}\textrm{d\textbf{u}}$

渲染中，由于被积函数$f$通常与场景参数$\pi\in\Pi$有关，所以密度函数$p$和采样映射$T$一般也都和场景参数有关；为了解决这种依赖问题，可以引入一个额外的假想参数$\pi_0$，其值恰好和$\pi$匹配，但不参与微分；这样就可以正常计算微分了：

$\part_\pi I=\int_U\frac{\part_\pi f(T(\textbf{u},\pi_0),\pi)}{p(T(\textbf{u},\pi_0),\pi_0)}\textrm{d\textbf{u}}$

虽然这种做法忽略了部分项可能会对结果造成影响，但只要对所有被积函数导数不为零的位置进行概率不为零的采样，就可以作为一种有效的计算方法。

有一点需要注意的是，接近于原函数的$p\approx f$不一定是微分式$\part_\pi f$最好的近似。

独立采样策略不适用于包含狄拉克函数的被积函数。该特性会影响诸如镜面法线的微分。

**依附采样策略**（Attached sampling strategies）大部分广泛使用的采样策略都依赖于场景参数，PBR中的例子包括：定向峰值分布的采样（依赖于粗糙度的微表面模型）、环境纹理图的直接采样、依赖于表面位置的BSDF采样等；这些例子中，如果对场景参数做了调整，生成的样本也会相应变化。独立采样策略不考虑这些影响，这也是它被称为独立采样策略的原因。现在使用依附采样策略将这种依赖性考虑进去：

$\part_\pi I=\int_U\part_\pi[\frac{f(T(\textbf{u},\pi),\pi)}{p(T(\textbf{u},\pi),\pi)}]\textrm{d\textbf{u}}$

显然，当$f$和$p$成比例时，这个微分式会简单很多，也就是重要性采样的优化策略还能用；但还有其他问题需要解决。

被积函数通常是一个复杂的乘积函数，可以表示成$f=g\cdot h$；但采样策略只针对其中的一个，假设是$g$项，也就是$p=C\cdot g$，则微分式变为：

$\part_\pi I=C^{-1}\int_U[h_\pi(x,\pi)+T_\pi(u,\pi)h_x(x,\pi)]\textrm{d}u$

其中，$x=T(u,\pi)$。微分式中不再含有$g$项，则由$g$项引起的方差就不存在了；但$h$项引起的方差却很严重。

依附采样天然可以解决含有delta函数的被积函数的积分问题。

*离散决策*：采样技术通常会使用均匀随机变量来进行离散决策。但和密度函数、参数化函数的统一微分不同的是，如果对这些离散决策进行微分可能会引入严重的偏差，比如通过俄罗斯轮盘赌来中止光线递归。

*不连续性的产生*：可以看出，大多数情况下，依附采样策略要由于独立采样策略。但是尝试用依附采样策略去微分具有不连续性的被积函数会遇到这样的基本问题：这些与场景参数相关的方法不但使采样变得复杂，也引入了不连续性。最终结果就是，即使在原场景下静态的不连续性，在变换之后也不再是静态，引入了偏差。不过这些问题可以通过**重新参数化依附采样**解决。

**多重重要性采样**（Multiple importance sampling）依附采样的优势在于可以考虑到场景参数的影响从而减少方差。但这在多重重要性采样上是很难见效的，很少出现对多重重要性采样影响很大的场景参数调整。对于多重重要性采样是否采用依附采样策略的考量就不再是从减少方差出发。

**独立采样估计，独立多重重要性采样**（Detached estimators, detached MIS）忽略MIS对场景参数的影响，可以得到微分式：

$\part_\pi I=\int_U\underset{i=1}{\overset{n}{\sum}}w_i(T_i(\textbf{u},\pi_0),\pi_0)\cdot\frac{\part_\pi f(T_i(\textbf{u},\pi_0),\pi)}{p_i(T_i(\textbf{u},\pi_0),\pi_0)}\textrm{d\textbf{u}}$

**依附采样估计，依附多重重要性采样**（Attached estimators, attached MIS）考虑MIS对场景参数的依赖，可以得到微分式：

$\part_\pi I=\int_U\underset{i=1}{\overset{n}{\sum}}\part_\pi[w_i(T_i(\textbf{u},\pi),\pi)\cdot\frac{f(T_i(\textbf{u},\pi),\pi)}{p_i(T_i(\textbf{u},\pi),\pi)}]\textrm{d\textbf{u}}$

**依附采样估计，独立多重重要性采样**（Attached estimators, detached MIS）不考虑MIS对场景的依赖，但使用依附采样策略：

$\part_\pi I\overset{?}{=}\int_U\underset{i=1}{\overset{n}{\sum}}w_i(T_i(\textbf{u},\pi_0),\pi_0)\cdot\part_\pi[\frac{f(T_i(\textbf{u},\pi),\pi)}{p_i(T_i(\textbf{u},\pi),\pi)}]\textrm{d\textbf{u}}$

显然，该策略很可能会引起严重的偏差。

**独立采样估计，依附多重重要性采样**（Detached estimators, attached MIS）考虑MIS对场景参数的依赖，但使用独立采样策略：

$\part_\pi I=\int_U\underset{i=1}{\overset{n}{\sum}}\frac{\part_\pi[w_i(T_i(\textbf{u},\pi_0),\pi)\cdot f(T_i(\textbf{u},\pi_0),\pi)]}{p_i(T_i(\textbf{u},\pi_0),\pi_0)}\textrm{d\textbf{u}}$

这个方法虽然正确，但并没有什么显著的优势。

**结合使用独立采样策略和依附采样策略**，当某些重要性采样与场景参数无关而另一些与场景参数有关时，可以结合使用两种采样策略。

**总结**：MIS仍然对采样策略有重要价值，根据实验结果，我们推荐使用完全独立的采样策略或者完全依附的采样策略。结合使用两种采样策略并不能带来实质的改进，该思路有待探索。

***

**微分采样策略**：实际上，重要性采样所需要的密度函数$p$和映射函数$T$不再需要和原始函数保持一致，这就意味着可以采用更灵活的采样策略来减少方差。

**微分微表面采样**（Differential microfacet sampling）数值实验表明，微表面模型对其粗糙度的求导结果具有很大的方差。这是由于被积函数的改变会使独立采样策略失效；另一方面，对乘积式使用依附采样策略可能会产生更糟糕的结果。使用解耦的微分传输模拟可以获得一种特定的微分采样策略，能够解决这个问题。

---

**重新参数化不连续的被积函数**

首先是类似于Loubet方法的部分，重新参数化需要满足$R(\textbf{x},\pi_0)=\textbf{x}$，这个条件保证了引入重新参数化不会改变原来的式子；其中，$\pi_0$是独立采样策略中的假定场景参数。除此以外，还需要满足$\part_\pi R(\textbf{x},\pi)=\part_\pi P(\textbf{x},\pi)$，其中$P:X\cross \Pi \rightarrow X$，参数化函数对参数求导返回一个位置，该位置的速度$\part_\pi P$必须谨慎选择。

一种容易设计的（满足以上条件的）重新参数化函数可以定义为：

$R(\textbf{x},\pi)=\textbf{x}+P(\textbf{x},\pi)-P(\textbf{x},\pi_0)$

但这个函数中仍然需要解决选择合适函数$P$的问题。实际上，$P$一定会是一个光滑函数，因为需要满足一个关键条件：如果$\textbf{x}$趋近于另一个依赖于参数$\pi$的点$\textbf{x}_b(\pi)$时，$\part_\pi P(\textbf{x},\pi)$一定也趋近于$\part_\pi\textbf{x}_b(\pi)$

Loubet给出了一种近似的函数$P$，可能会引入一些偏差；Bangaru对此做了一些改进，他通过对基础位置$\bar{P}$和卷积核$w$做球面卷积得到：

$P(\textbf{x},\pi)=\frac{\int_\chi w(\textbf{x,x'})\bar{P}(\textbf{x'},\pi)\textrm{d}\textbf{x'}}{\int_\chi w(\textbf{x,x'})\textrm{d}\textbf{x'}}$

函数$\bar{P}(\textbf{x},\pi)$返回光线在$\textbf{x}$方向上的交点位置（球坐标）；权重卷积核$w$会在$\textbf{x}和\textbf{x'}$接近轮廓时变得非常大。

**重新参数化辐射度反向传播**

将辐射度反向传播的散射部分用重新参数化函数重写：

$L_o(\textbf{p},\omega)=L_e(\textbf{p},\omega)+\int_{S^2}L_i(\textbf{p},R(\omega',\pi))f_s(\omega,R(\omega',\pi))\abs{J_R(\textbf{x},\pi)}\textrm{d}\omega'^{\perp}$

对重新参数化后的式子进行微分：

![](D:\Projects\Github\RayTracingRenderer\笔记材料\微分重新参数化的RB.png)

上式已经过化简：函数$R$和Jacobian项在不需要微分的项中会变为单位值。

相比于未经过重新参数的辐射度反向传播，最后一项是之前没有的，且现在的式子中每一项都包含场景参数。

Bangaru将Jacobian行列式和向量场的散度联系了起来，使用这种方式可以更容易地近似将其与函数$P$结合。整理后得到$\part_\pi\abs{J_R(\textbf{x},\pi)}=\nabla\omega\cdot\part_\pi R=\part_\pi(\nabla\omega\cdot R)$

**重新参数化依附采样策略**

为了解决场景参数所引发的静态不连续性移动的问题，我们使用一种二次参数化方法，可以抵消由不连续性移动所引起的偏差：

$R(\textbf{x},\pi)=\textbf{x}-B(\textbf{x})T(\textbf{u},\pi)+B(\textbf{x})T(\textbf{u},\pi_0)$

其中的$B(\textbf{x})$可以被解释为一种平滑的缩放系数，用于减缓采样样本靠近不连续性时的移动速度。
