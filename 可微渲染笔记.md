# 可微光线传播的蒙特卡洛估计

为了支持可微渲染，正向的渲染积分过程被改造得面目全非，本篇论文的主要目的就是将可微渲染从正向渲染积分过程中解耦出来，避免其对正向渲染算法的影响。

这种解耦的方案实在是太多了：是只对蒙特卡洛估计求解导数，还是对采样方法求解导数？重要性采样应该应用在求解导数之前还是之后？专门的可微采样策略还需要用吗？当数百万参数同时求解导数时，可见性不连续的问题该如何解决？本篇论文是有关可微光线传播的不同蒙特卡洛估计方法的分类和分析的讨论。

过去的三维重建和逆向问题大多是基于特定需求和假设的前提下设计的解决方案。比如CT扫描重建就假设了被扫描对象是吸收X光线的，如果其中有金属之类对X光产生较多反射的材料，就会严重影响重建算法，在最终得到的图像中也会出现大量的伪影。

结构光重建技术在遇到镜面物体把特定光照图案反射到其他位置时，也会严重影响其重建的效果。

整体上来说，图片的信息非常复杂，包含形状、相互作用、光照、材质等信息，还有很多的间接信息，比如阴影、反射等，将场景中不同的物体都耦合到一起。照在物体表面的聚光灯效果可能会被当成纹理，光源或者来自于其他物体的反射。要想解决这些不确定性，就需要结合使用多种不同的观察和重建技术，考察光线传播和散射过程中的作用效果。

本篇论文介绍可微渲染的数学理论基础，以此说明逆向问题的实质是一类高维空间的梯度优化问题。数百万的场景参数包含了光照、形状、材质等信息，场景参数的导数信息解耦了场景中的辐射度信息，提供了高维空间中最速上升的方向，为解决逆向问题贡献了不可多得的关键信息。

目前来说，可微渲染算法的创造遵循非常固定的步骤：可微首先被纳入求解光线传播积分的标准方法中（如路径追踪），其中可能会增加一些额外的步骤来解决可见性不连续问题；然后，对积分问题的可微被推广到更通用的计算中，或手动求解，或使用自动微分器求解。

虽然这种步骤创造出来的算法基本都是有效的，但是会从根本上改变底层的积分过程。场景参数可能会非常敏感，一个很小的扰动就会导致积分渲染结果产生很大的变动，然后根据蒙特卡洛算法的原理，就需要投放相应比例的采样数到这些区域以达到更快的收敛。但是，这种方法在可微渲染算法中是无法轻易实现的，因为可微渲染算法都是从某个固定的正向渲染过程中导出的；最坏的情况下，这些敏感的区域在正向渲染过程中甚至可能会被丢弃，从而使得可微算法产生偏差。

有一种被称为“辐射度反向传播”的算法将可微渲染推广到反向传播中，从传感器向物体传播辐射度的可微参数。该方法解耦了正向积分和可微估计，是我们工作的起点。虽然该解耦算法提供了很大的自由度，但仍然表现出其对可微渲染本质的不了解，本篇论文将从以下方面介绍如何设计可微光线传播估计算法：

- 采用重要性采样的蒙特卡洛估计通常都会使用逆向方法，将均匀分布改造成目标分布。如果要设计可微的蒙特卡洛估计，这种改造既可以保持不变，也可以使得它可微起来；这两种方案我们分别称为“独立策略”和“依附策略”。独立策略使用静态采样数，依附策略则根据参数的变化而调整采样数。
- 采样策略一般不单独使用，通常会使用“多重重要性采样”的框架。根据不同的方案，多重重要性采样的权重既可以保持原样，也可以根据参数变化调整。
- 采样策略是用于近似实际的积分分布形状的，但无论使用哪种方案，这种近似都可能会随着可微化而失效。这种情况下就需要设计专门的策略来适配新的积分形状，我们称这种策略为“可微策略”。我们会为微表面模型给出一种可微策略，并且分析论证使用这种策略的优势。
- 可见性不连续的问题仍然需要谨慎对待。我们会介绍一些技术绕开这个问题，从而得以应用辐射度反向传播技术和几何优化方法。
- 并不是所有方案都互相兼容的，有些独立或依附的多重重要性采样和一些独立或依附的采样策略得到的是有偏估计，有些依附策略采样会影响不连续积分的处理。
- 最后，渲染方法经常使用各种各样的随机方法，包括中止路径追踪的俄罗斯轮盘赌和对BSDF的采样。我们会证明这些随机方法不应当可微化，否则会严重影响结果的无偏性。