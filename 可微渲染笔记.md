# 1. 微分光线传播的蒙特卡洛估计

为了支持可微渲染，正向的渲染积分过程被改造得面目全非，本篇论文的主要目的就是将可微渲染从正向渲染积分过程中解耦出来，避免其对正向渲染算法的影响。

这种解耦的方案实在是太多了：是只对蒙特卡洛估计求解导数，还是对采样方法求解导数？重要性采样应该应用在求解导数之前还是之后？专门的可微采样策略还需要用吗？当数百万参数同时求解导数时，可见性不连续的问题该如何解决？本篇论文是有关可微光线传播的不同蒙特卡洛估计方法的分类和分析的讨论。

过去的三维重建和逆向问题大多是基于特定需求和假设的前提下设计的解决方案。比如CT扫描重建就假设了被扫描对象是吸收X光线的，如果其中有金属之类对X光产生较多反射的材料，就会严重影响重建算法，在最终得到的图像中也会出现大量的伪影。

结构光重建技术在遇到镜面物体把特定光照图案反射到其他位置时，也会严重影响其重建的效果。

整体上来说，图片的信息非常复杂，包含形状、相互作用、光照、材质等信息，还有很多的间接信息，比如阴影、反射等，将场景中不同的物体都耦合到一起。照在物体表面的聚光灯效果可能会被当成纹理，光源或者来自于其他物体的反射。要想解决这些不确定性，就需要结合使用多种不同的观察和重建技术，考察光线传播和散射过程中的作用效果。

本篇论文介绍可微渲染的数学理论基础，以此说明逆向问题的实质是一类高维空间的梯度优化问题。数百万的场景参数包含了光照、形状、材质等信息，场景参数的导数信息解耦了场景中的辐射度信息，提供了高维空间中最速上升的方向，为解决逆向问题贡献了不可多得的关键信息。

目前来说，可微渲染算法的创造遵循非常固定的步骤：可微首先被纳入求解光线传播积分的标准方法中（如路径追踪），其中可能会增加一些额外的步骤来解决可见性不连续问题；然后，对积分问题的可微被推广到更通用的计算中，或手动求解，或使用自动微分器求解。

虽然这种步骤创造出来的算法基本都是有效的，但是会从根本上改变底层的积分过程。场景参数可能会非常敏感，一个很小的扰动就会导致积分渲染结果产生很大的变动，然后根据蒙特卡洛算法的原理，就需要投放相应比例的采样数到这些区域以达到更快的收敛。但是，这种方法在可微渲染算法中是无法轻易实现的，因为可微渲染算法都是从某个固定的正向渲染过程中导出的；最坏的情况下，这些敏感的区域在正向渲染过程中甚至可能会被丢弃，从而使得可微算法产生偏差。

有一种被称为“辐射度反向传播”的算法将可微渲染推广到反向传播中，从传感器向物体传播辐射度的可微参数。该方法解耦了正向积分和可微估计，是我们工作的起点。虽然该解耦算法提供了很大的自由度，但仍然表现出其对可微渲染本质的不了解，本篇论文将从以下方面介绍如何设计可微光线传播估计算法：

- 采用重要性采样的蒙特卡洛估计通常都会使用逆向方法，将均匀分布改造成目标分布。如果要设计可微的蒙特卡洛估计，这种改造既可以保持不变，也可以使得它可微起来；这两种方案我们分别称为“独立策略”和“依附策略”。独立策略使用静态采样数，依附策略则根据参数的变化而调整采样数。
- 采样策略一般不单独使用，通常会使用“多重重要性采样”的框架。根据不同的方案，多重重要性采样的权重既可以保持原样，也可以根据参数变化调整。
- 采样策略是用于近似实际的积分分布形状的，但无论使用哪种方案，这种近似都可能会随着可微化而失效。这种情况下就需要设计专门的策略来适配新的积分形状，我们称这种策略为“可微策略”。我们会为微表面模型给出一种可微策略，并且分析论证使用这种策略的优势。
- 可见性不连续的问题仍然需要谨慎对待。我们会介绍一些技术绕开这个问题，从而得以应用辐射度反向传播技术和几何优化方法。
- 并不是所有方案都互相兼容的，有些独立或依附的多重重要性采样和一些独立或依附的采样策略得到的是有偏估计，有些依附策略采样会影响不连续积分的处理。
- 最后，渲染方法经常使用各种各样的随机方法，包括中止路径追踪的俄罗斯轮盘赌和对BSDF的采样。我们会证明这些随机方法不应当可微化，否则会严重影响结果的无偏性。

对蒙特卡洛模拟求导曾经被用于建模核反应的临界条件，也曾被用于对组织细胞进行逆向建模，这类方法被称为“摄动蒙特卡洛法”或者“可微蒙特卡洛法”。

渲染中使用导数来计算纹理滤波、梯度域的渲染、自适应采样和重建、非漫反射全局光照等。具有高光或者靠近高光的光路常给渲染带来很多难题，路径求导提供了高效搜索和外推的方案。

可微渲染在计算视觉领域也有很多的应用。逆向渲染是计算视觉领域的一个基本问题，之前已经有大量工作研究了图像处理过程的微分方法。一些间接的效果，如阴影、间接反射、景深等，在过去并不是这类研究中的重点内容，相关工作主要集中在对于网格和体积的可微光栅化方法的可见性问题上。

计算机图形学中的可微渲染。基于物理的可微渲染计算了关于场景参数的偏导数。

间接效果在优化材质中尤为重要，比如具有显著多次散射特征的参与介质。早期的基于物理的可微渲染依赖于正向可微渲染来传递一些导数信息，这需要对每一个目标参数额外地跑一遍计算；后来的反向可微渲染可以一次性计算出所有的场景参数导数。

反向可微渲染的广泛使用极大地提高了大量参数求导的速度，但同样带来了一些问题：导数计算需要得到原始计算的中间步骤，并且该顺序与原始程序的执行顺序相反。如果没有临时存储的原始变量，是无法逆转程序的，而这些需要临时存储的数据量非常庞大。

**辐射度反向传播**（radiative backpropagation）算法给出了这样一种解决方案，它意识到，反向传播可以当作求解辐射度传播的偏导数，这个偏导数由相机发射、场景物体散射，最终被含有可微参数的物体接收。由此，可微渲染过程可以被拆解为两个阶段用以处理复杂的高分辨率场景。*具体一点，先进行一次正向的渲染，根据渲染结果求解目标参数的伴随敏感度；然后将伴随敏感度反向传播（像辐射度渲染一样）回去，就可以得到参数导数。*

***

**独立采样策略**（Detached sampling strategies）该方法的灵感来自于手动求解常微分方程的过程，是一种解析解法，不关心数值结果。该方法简单地移动了偏导数的位置并在积分下求导：

$\partial_\pi I=\partial_\pi [\int_\chi f(\textbf{x},\pi)\textrm{d\textbf{x}}]=\int_\chi \partial_\pi f(\textbf{x},\pi)\textrm{d\textbf{x}}$

如果不存在非连续问题，那么这种变换是没有问题的。它也适用于非连续性是静态的情况，也就是与$\pi$无关时。

*重用性采样*：鉴于大部分光线传输的积分方程都会使用带有重要性采样的蒙特卡洛方法求解，那么解决重要性采样的可微就是必要的。考虑一组微分同胚$T:U\rightarrow X$，目标域$X$由$n$维单位超立方体$U=[0,1]^n$参数化。映射关系$\textbf{x}=T(\textbf{u})$由目标密度函数$p(\textbf{x})$构造，则其雅可比行列式满足$\left|{J(\textbf{u})}\right|=p(\textbf{x})^{-1}$，重新调整一下原始的积分式可以得到：

$I=\int_U f(T(\textbf{u}))\left|{J(\textbf{u})}\right|\textrm{d\textbf{u}}=\int_U \frac{f(T(\textbf{u}))}{p(T(\textbf{u}))}\textrm{d\textbf{u}}$

对其进行微分：

$\partial_\pi I=\int_U\frac{\partial_\pi f(T(\textbf{u}))}{p(T(\textbf{u}))}\textrm{d\textbf{u}}$

渲染中，由于被积函数$f$通常与场景参数$\pi\in\Pi$有关，所以密度函数$p$和采样映射$T$一般也都和场景参数有关；为了解决这种依赖问题，可以引入一个额外的假想参数$\pi_0$，其值恰好和$\pi$匹配，但不参与微分；这样就可以正常计算微分了：

$\partial_\pi I=\int_U\frac{\partial_\pi f(T(\textbf{u},\pi_0),\pi)}{p(T(\textbf{u},\pi_0),\pi_0)}\textrm{d\textbf{u}}$

虽然这种做法忽略了部分项可能会对结果造成影响，但只要对所有被积函数导数不为零的位置进行概率不为零的采样，就可以作为一种有效的计算方法。

有一点需要注意的是，接近于原函数的$p\approx f$不一定是微分式$\partial_\pi f$最好的近似。

独立采样策略不适用于包含狄拉克函数的被积函数。该特性会影响诸如镜面法线的微分。

**依附采样策略**（Attached sampling strategies）大部分广泛使用的采样策略都依赖于场景参数，PBR中的例子包括：定向峰值分布的采样（依赖于粗糙度的微表面模型）、环境纹理图的直接采样、依赖于表面位置的BSDF采样等；这些例子中，如果对场景参数做了调整，生成的样本也会相应变化。独立采样策略不考虑这些影响，这也是它被称为独立采样策略的原因。现在使用依附采样策略将这种依赖性考虑进去：

$\partial_\pi I=\int_U\partial_\pi[\frac{f(T(\textbf{u},\pi),\pi)}{p(T(\textbf{u},\pi),\pi)}]\textrm{d\textbf{u}}$

显然，当$f$和$p$成比例时，这个微分式会简单很多，也就是重要性采样的优化策略还能用；但还有其他问题需要解决。

被积函数通常是一个复杂的乘积函数，可以表示成$f=g\cdot h$；但采样策略只针对其中的一个，假设是$g$项，也就是$p=C\cdot g$，则微分式变为：

$\partial_\pi I=C^{-1}\int_U[h_\pi(x,\pi)+T_\pi(u,\pi)h_x(x,\pi)]\textrm{d}u$

其中，$x=T(u,\pi)$。微分式中不再含有$g$项，则由$g$项引起的方差就不存在了；但$h$项引起的方差却很严重。

依附采样天然可以解决含有delta函数的被积函数的积分问题。

*离散决策*：采样技术通常会使用均匀随机变量来进行离散决策。但和密度函数、参数化函数的统一微分不同的是，如果对这些离散决策进行微分可能会引入严重的偏差，比如通过俄罗斯轮盘赌来中止光线递归。

*不连续性的产生*：可以看出，大多数情况下，依附采样策略要由于独立采样策略。但是尝试用依附采样策略去微分具有不连续性的被积函数会遇到这样的基本问题：这些与场景参数相关的方法不但使采样变得复杂，也引入了不连续性。最终结果就是，即使在原场景下静态的不连续性，在变换之后也不再是静态，引入了偏差。不过这些问题可以通过**重新参数化依附采样**解决。

**多重重要性采样**（Multiple importance sampling）依附采样的优势在于可以考虑到场景参数的影响从而减少方差。但这在多重重要性采样上是很难见效的，很少出现对多重重要性采样影响很大的场景参数调整。对于多重重要性采样是否采用依附采样策略的考量就不再是从减少方差出发。

**独立采样估计，独立多重重要性采样**（Detached estimators, detached MIS）忽略MIS对场景参数的影响，可以得到微分式：

$\partial_\pi I=\int_U\underset{i=1}{\overset{n}{\sum}}w_i(T_i(\textbf{u},\pi_0),\pi_0)\cdot\frac{\partial_\pi f(T_i(\textbf{u},\pi_0),\pi)}{p_i(T_i(\textbf{u},\pi_0),\pi_0)}\textrm{d\textbf{u}}$

**依附采样估计，依附多重重要性采样**（Attached estimators, attached MIS）考虑MIS对场景参数的依赖，可以得到微分式：

$\partial_\pi I=\int_U\underset{i=1}{\overset{n}{\sum}}\partial_\pi[w_i(T_i(\textbf{u},\pi),\pi)\cdot\frac{f(T_i(\textbf{u},\pi),\pi)}{p_i(T_i(\textbf{u},\pi),\pi)}]\textrm{d\textbf{u}}$

**依附采样估计，独立多重重要性采样**（Attached estimators, detached MIS）不考虑MIS对场景的依赖，但使用依附采样策略：

$\partial_\pi I\overset{?}{=}\int_U\underset{i=1}{\overset{n}{\sum}}w_i(T_i(\textbf{u},\pi_0),\pi_0)\cdot\partial_\pi[\frac{f(T_i(\textbf{u},\pi),\pi)}{p_i(T_i(\textbf{u},\pi),\pi)}]\textrm{d\textbf{u}}$

显然，该策略很可能会引起严重的偏差。

**独立采样估计，依附多重重要性采样**（Detached estimators, attached MIS）考虑MIS对场景参数的依赖，但使用独立采样策略：

$\partial_\pi I=\int_U\underset{i=1}{\overset{n}{\sum}}\frac{\partial_\pi[w_i(T_i(\textbf{u},\pi_0),\pi)\cdot f(T_i(\textbf{u},\pi_0),\pi)]}{p_i(T_i(\textbf{u},\pi_0),\pi_0)}\textrm{d\textbf{u}}$

这个方法虽然正确，但并没有什么显著的优势。

**结合使用独立采样策略和依附采样策略**，当某些重要性采样与场景参数无关而另一些与场景参数有关时，可以结合使用两种采样策略。

**总结**：MIS仍然对采样策略有重要价值，根据实验结果，我们推荐使用完全独立的采样策略或者完全依附的采样策略。结合使用两种采样策略并不能带来实质的改进，该思路有待探索。

***

**微分采样策略**：实际上，重要性采样所需要的密度函数$p$和映射函数$T$不再需要和原始函数保持一致，这就意味着可以采用更灵活的采样策略来减少方差。

**微分微表面采样**（Differential microfacet sampling）数值实验表明，微表面模型对其粗糙度的求导结果具有很大的方差。这是由于被积函数的改变会使独立采样策略失效；另一方面，对乘积式使用依附采样策略可能会产生更糟糕的结果。使用解耦的微分传输模拟可以获得一种特定的微分采样策略，能够解决这个问题。

---

**重新参数化不连续的被积函数**

首先是类似于Loubet方法的部分，重新参数化需要满足$R(\textbf{x},\pi_0)=\textbf{x}$，这个条件保证了引入重新参数化不会改变原来的式子；其中，$\pi_0$是独立采样策略中的假定场景参数。除此以外，还需要满足$\partial_\pi R(\textbf{x},\pi)=\partial_\pi P(\textbf{x},\pi)$，其中$P:X\times \Pi \rightarrow X$，参数化函数对参数求导返回一个位置，该位置的速度$\partial_\pi P$必须谨慎选择。

一种容易设计的（满足以上条件的）重新参数化函数可以定义为：

$R(\textbf{x},\pi)=\textbf{x}+P(\textbf{x},\pi)-P(\textbf{x},\pi_0)$

但这个函数中仍然需要解决选择合适函数$P$的问题。实际上，$P$一定会是一个光滑函数，因为需要满足一个关键条件：如果$\textbf{x}$趋近于另一个依赖于参数$\pi$的点$\textbf{x}_b(\pi)$时，$\partial_\pi P(\textbf{x},\pi)$一定也趋近于$\partial_\pi\textbf{x}_b(\pi)$

Loubet给出了一种近似的函数$P$，可能会引入一些偏差；Bangaru对此做了一些改进，他通过对基础位置$\bar{P}$和卷积核$w$做球面卷积得到：

$P(\textbf{x},\pi)=\frac{\int_\chi w(\textbf{x,x'})\bar{P}(\textbf{x'},\pi)\textrm{d}\textbf{x'}}{\int_\chi w(\textbf{x,x'})\textrm{d}\textbf{x'}}$

函数$\bar{P}(\textbf{x},\pi)$返回光线在$\textbf{x}$方向上的交点位置（球坐标）；权重卷积核$w$会在$\textbf{x}和\textbf{x'}$接近轮廓时变得非常大。

**重新参数化辐射度反向传播**

将辐射度反向传播的散射部分用重新参数化函数重写：

$L_o(\textbf{p},\omega)=L_e(\textbf{p},\omega)+\int_{S^2}L_i(\textbf{p},R(\omega',\pi))f_s(\omega,R(\omega',\pi))\left|{J_R(\textbf{x},\pi)}\right|\textrm{d}\omega'^{\perp}$

对重新参数化后的式子进行微分：

![](D:\Projects\Github\RayTracingRenderer\笔记材料\微分重新参数化的RB.png)

上式已经过化简：函数$R$和Jacobian项在不需要微分的项中会变为单位值。

相比于未经过重新参数的辐射度反向传播，最后一项是之前没有的，且现在的式子中每一项都包含场景参数。

Bangaru将Jacobian行列式和向量场的散度联系了起来，使用这种方式可以更容易地近似将其与函数$P$结合。整理后得到$\partial_\pi\left|{J_R(\textbf{x},\pi)}\right|=\nabla\omega\cdot\partial_\pi R=\partial_\pi(\nabla\omega\cdot R)$

**重新参数化依附采样策略**

为了解决场景参数所引发的静态不连续性移动的问题，我们使用一种二次参数化方法，可以抵消由不连续性移动所引起的偏差：

$R(\textbf{x},\pi)=\textbf{x}-B(\textbf{x})T(\textbf{u},\pi)+B(\textbf{x})T(\textbf{u},\pi_0)$

其中的$B(\textbf{x})$可以被解释为一种平滑的缩放系数，用于减缓采样样本靠近不连续性时的移动速度。如果将$B(\textbf{x})$设为常数，就变成了独立采样策略。基于此，可以在接近不连续性区域的时候，将采样策略改为独立采样策略。Bangaru在论文中提出的边缘测试方案对这种情况依然奏效。

# 2. 实时神经辐射度缓存光线追踪

实时全局光照应当遵守的三大原则：

- 动态场景（包括相机、光照、几何、材质等）
- 稳定
- 开销可预测（不超过线性复杂度）

---

**相关工作**包括预计算的全局光照、动态全局光照、人工智能全局光照。

*辐射度缓存*：实时全局光照技术大多起源于辐照度缓存技术，它们假定了间接光照之间是平滑的，可以从albedo中重建，后来还发展出了辐照度探针之类的技术。但探针的摆放和中间的插值是非常复杂的，而且在间接光照不平滑的场景中，效果也并不好。为了得到更稳定的解决方案，人们不再使用假定了Lambert材质的辐照度，而改为考虑使用辐射度缓存。早期的算法使用球谐函数来表示方向域上的辐射度，后续有很多工作进一步发展了辐射度缓存，包括在离线渲染中的使用、压缩后在实时渲染中使用、稀疏插值、预卷积环境贴图、空间哈希等。

*预计算技术*：全局光照的恐怖计算开销催生了预计算技术的发展。当场景光照和几何体固定了，就可以预计算辐照度并存储到光照贴图中，也可以存储到光照探针中。光照探针也可以结合辐射度传播或可见性的预计算，用于遮挡的计算。

*动态全局光照*：动态全局光照主要通过对屏幕像素的着色和可见性计算的重新利用。该类算法有光子映射、多光渲染、辐射烘焙（Radiosity maps）。一些方法使用点云来近似场景几何体，之后可以光栅化地填充进阴影贴图中；一些方法使用体积近似场景光照和几何体，

# 3. PBDR，由理论到实践

**自然方法的局限性**：直接对积分过程离散化并使用自动微分器并不能获得正确且收敛的微分结果。

**一致性离散**：如果离散结果收敛到积分结果，则称其为*与积分一致的离散*。

**无偏离散**：如果离散结果的期望与积分结果相同，则称其为*与积分无偏的离散*。

**离散方法处理不连续性存在的问题**：由于一个样本的导数只能检测到局部的变化，而一个样本落在边界上的概率为零。

---

误差函数对场景参数的导数：$\frac{\partial}{\partial\pi}L(I(\mathbf{\pi})=\underset{i}{\sum}\frac{\partial L}{\partial I_i(\mathbf{\pi})}\frac{\partial I_i(\mathbf{\pi})}{\partial\pi}$

误差函数$L$可以任取可微的函数，包括神经网络；这部分的微分可以通过反向传播或者逆向自动微分器实现。

主要工作在于像素颜色对于场景参数的导数，也就是$\frac{\partial I_i(\pi)}{\partial \pi}$这部分。

虽然渲染过程的被积函数是不连续、不可微的，但是积分过程是可微的，这是可微渲染的理论基础。

数值积分方法的基本形式是：$I_i\approx\frac{1}{N}\underset{j=1}{\overset{N}{\sum}}f(x_i,y_i;\mathbf{\pi})$

但不能对改该积分形式使用自动微分，因为$f$函数仅根据像素位置$(x,y)$获取三角形颜色，这使得数值积分法对顶点位置的导数恒为0。但显然，积分过程对顶点位置的导数不为0：

$\frac{\partial}{\partial\pi_v}\int\int f(x,y;\mathbf{\pi})dxdy \not\approx \frac{1}{N}\underset{j=1}{\overset{N}{\sum}}\frac{\partial}{\partial \pi_v}f(x_j,y_j;\mathbf{\pi})=0$

一般情况下，对于不连续被积函数的离散化和梯度计算是不能交换的，这是因为导数是度量局部变化的，而均匀离散在不连续处的概率为0。这个问题可以简化为下式：

$\frac{\partial}{\partial p}\int_0^1(x<p\space ?\space1:0)dx$

如果将函数离散化后计算对$p$的导数，（因为不含有$p$）则对$p$的导数恒为0；然而，对于$0\leq p \leq 1$的积分结果为$p$，所以先积分再对$p$求导的结果应该是1。

上述现象的成因在于，离散积分方法依赖于点采样，而采样点只能触及周边极小范围($x_j-\epsilon,x_j+\epsilon$)内的变化；如果被积函数中存在阶跃函数，那么只有采样到阶跃的临界点才会发生数值的突变；然而，采样到临界点的概率实际上为0，所以无法在离散过程中捕捉到导数的变化。

---

### 分布导数与狄拉克$\delta$函数

首先引入形式化方法描述该类问题，对于不连续偶函数的导数，我们称其为**分布导数**。

上一节中被积函数（阶跃函数）的分布导数是一种狄拉克$\delta$函数（仅在一处为1，其他处处为0，但积分结果为1）：

$\frac{\partial}{\partial p}x<p\space ?\space 1:0=\delta(x-p)$

严格意义上，$\delta(x-p)$并不是一种函数（不是映射），而是一种分布。我们只能通过积分的方式来计算狄拉克$\delta$：$\int_0^1\delta(x-p)=1\quad where\space 0\leq p \leq 1$。

数学推导中使用狄拉克$\delta$函数并不容易，因为它并不是一种函数，而是一种分布。例如两个狄拉克$\delta$函数的乘积就不具备良好定义。但我们仍然可以使用狄拉克$\delta$函数来推导可微渲染。

---

### 使用莱布尼茨公式求解一维积分的微分结果

为了求解不连续函数的导数，我们的方案是沿着不连续的边界拆分积分过程，这样就可以将不连续函数的求导分为两部分进行：对连续的部分求导和对不连续的部分求导。

仍然以之前的阶跃函数为例，我们可以将其拆解为两部分：

$\frac{\partial}{\partial p}\int_0^1(x<p\space?\space1:0)dx=\frac{\partial}{\partial p}\int_0^p 1dx+\frac{\partial}{\partial p}\int_p^1 0dx$

这样，计算得到的导数值为1。

推广到一般化的情况需要使用莱布尼茨公式，我们定义场景参数$\pi\in\mathbb{R}$，并考虑如下的黎曼和形式（满足$(a(\pi),b(\pi))\subset\mathbb{R}$）：

$\int_{a(\pi)}^{b(\pi)}f(x;\pi)dx$

其中，被积函数$f$对于任意的$x$和$\pi$，处处可导。那么，由莱布尼茨公式，我们可以得到积分式对于场景参数$\pi$的导数为：

$\frac{\partial}{\partial\pi}\int_{a(\pi)}^{b(\pi)}f(x;\pi)dx=\int_{a(\pi)}^{b(\pi)}\dot{f}(x;\pi)dx+\dot{b}(\pi)f(b(\pi);\pi)-\dot{a}(\pi)f(a(\pi);\pi)$

其中，$\dot{f}:=\partial f /\partial\pi,\space \dot{a}:=da/d\pi\space \dot{b}:=db/d\pi$

可以看到，第一部分的积分形式仍然符合黎曼和形式，只是被积函数变成了微分形式；第二部分则是通过积分边界上的变化率$\dot{a}(\pi)$和$\dot{b}(\pi)$来调节边界值的计算（莱布尼茨公式）。

现在来讨论有关莱布尼茨积分法则的具体内容。

莱布尼茨法则的一般形式表述为：$\frac{d}{dx}(\int_{a(x)}^{b(x)}f(x,t)dt)=f(x,b(x))\cdot\frac{d}{dx}b(x)-f(x,a(x))\cdot\frac{d}{dx}a(x)+\int_{a(x)}^{b(x)}\frac{\partial}{\partial x}f(x,t)dt$

等式右侧最后一部分采用了偏微分的书写形式，这意味着是在积分内部求取（偏）导数。

先从$a(x)=a,\quad b(x)=b$的特例入手，我们得到：$\frac{d}{dx}(\int_a^bf(x,t)dt)=\int_a^b\frac{\partial}{\partial x}f(x,t)dt$

该特例的证明很简单，首先设：$u(x)=\int_a^b f(x,t)dt$

则由导数定义可以得到：$u'(x)=\underset{h\to 0}{lim}\frac{u(x+h)-u(x)}{h}\\=\underset{h\to 0}{lim}\frac{\int_a^b(f(x+h,t)-f(x,t))dt}{h}\\=\underset{h\to 0}{lim}\int_a^b\frac{f(x+h,t)-f(x,t)}{h}dt$

于是得到该特殊形式：$u'(x)=\int_a^bf_x(x,t)dt$

推广到一般形式，我们先设：$\psi(\alpha)=\int_a^bf(x,\alpha)dx$

其中，$a,b$是关于$\alpha$的函数，我们有：$\Delta\psi=\psi(\alpha+\Delta\alpha)-\psi(\alpha)\\=\int_{a+\Delta a}^{b+\Delta b}f(x,\alpha+\Delta\alpha)dx-\int_a^bf(x,\alpha)dx\\=\int_{a+\Delta a}^af(x,\alpha+\Delta\alpha)dx+\int_a^bf(x,\alpha+\Delta\alpha)dx+\int_b^{b+\Delta b}f(x,\alpha+\Delta\alpha)dx-\int_a^bf(x,\alpha)dx\\=-\int_a^{a+\Delta a}f(x,\alpha+\Delta\alpha)dx+\int_a^b[f(x,\alpha+\Delta\alpha)-f(x,\alpha)]dx+\int_b^{b+\Delta b}f(x,\alpha+\Delta\alpha)dx\\=-\Delta af(\xi_1,\alpha+\Delta\alpha)+\int_a^b[f(x,\alpha+\Delta\alpha)-f(x,\alpha)]dx+\Delta bf(\xi_2,\alpha+\Delta\alpha)$

又因为：$\underset{\Delta\alpha\to0}{lim}\int_a^b\frac{f(x,\alpha+\Delta\alpha)-f(x,\alpha)}{\Delta\alpha}dx=\int_a^b\frac{\partial}{\partial\alpha}f(x,\alpha)dx$

所以有：$\frac{d\psi}{d\alpha}=\int_a^b\frac{\partial}{\partial\alpha}f(x,\alpha)dx+f(b,\alpha)\frac{db}{d\alpha}-f(a,\alpha)\frac{da}{d\alpha}$

进一步推广莱布尼茨公式，我们可以得到含有两个函数变量的形式：

$\frac{d}{dx}(\int_{f_1(x)}^{f_2(x)}h(x)g(t)dt=\frac{d}{dx}(h(x)\int_{f_1(x)}^{f_2(x)}g(t)dt)\\=h'(x)\int_{f_1(x)}^{f_2(x)}g(t)dt+h(x)\frac{d}{dx}(\int_{f_1(x)}^{f_2(x)}g(t)dt)$

最后，如果将莱布尼茨公式推广到二维空间中移动的二维表面（证明需要用到斯托克斯定理、线积分和面积分等），则莱布尼茨积分规则表述为：

$\frac{d}{dt}\int\int_{\Sigma(t)}\mathbf{F}(\mathbf{r},t)d\mathbf{A}=\int\int_{\Sigma(t)}(\mathbf{F}_t(\mathbf{r},t)+[\nabla\cdot\mathbf{F}(\mathbf{r},t)]\mathbf{v})\cdot d\mathbf{A}-\oint_{\partial\Sigma(t)}[\mathbf{v}\times\mathbf{F}(\mathbf{r},t)]\cdot d\mathbf{s}$

其中，$\mathbf{F}(\mathbf{r},t)$表示时间$t$在空间位置$\mathbf{r}$处的向量场，$\Sigma$是由曲线$\partial\Sigma$闭合包围的表面，$d\mathbf{A}$是$\Sigma$表面的向量元素，$d\mathbf{s}$是曲线$\partial\Sigma$的向量元素，$\mathbf{v}$是区域$\Sigma$的移动速度，$\nabla\cdot$是向量散度。

**回到不连续函数部分**，我们现在可以多次使用莱布尼茨公式处理分割为多段的情况。不妨设分割处的点集为$p_0,p_1,...,p_{M-1}$，则对积分的求导可以表述为：

$\frac{\partial}{\partial\pi}\int_0^1f(x;\pi)dx=\int_0^1\dot{f}(x;\pi)dx+\underset{k=0}{\overset{M}{\sum}}(f^-(p_k;\pi)-f^+(p_k;\pi))$

其中，我们定义不连续点$x$处的左侧极限为$f^-(x;\pi)=lim_{x'\to x^-}f(x';\pi)$；右侧极限为$\quad f^+(x;\pi)=lim_{x'\to x^+}f(x';\pi)$；为了方便表述，对于在$(x;\pi)$处不可微的函数$f$，我们定义$\dot{f}(x;\pi)=0$。

直观来看，上式的处理是直接对函数中不连续点处两侧的差值求和（加上右侧极限，减去左侧极限），我们也可以使用分布导数推导出相同的结果，$p_k$处的导数也都是狄拉克$\delta$函数，可以积分到离散和中。另外，对于不连续点处的处理，即使放到连续点上也是不受影响的，因为连续点处两侧的极限相等，所以差值为0。

为了将上述形式推广到二维乃至更高维，我们需要借助于流体力学中的数学工具来跟踪物体表面的变化，被称为“雷诺传输定理”。

---

### 使用雷诺传输定理求导高维积分

与一维情形类似，我们也希望在高维下可以采样不连续性并计算不连续边界两侧的差值。

雷诺传输定理是对莱布尼茨公式的推广。

我们设$f$是一个定义在$n$维流形$\Omega(\pi)$上的（可能存在不连续的）标量函数，具有参数$\pi\in\mathbb{R}$。另外，我们定义$\Gamma(\pi)\subset\Omega(\pi)$是一个$n-1$维的流形，它由外边界$\partial\Omega(\pi)$和$f$的内部不连续位置组成。于是有（雷诺传输定理）：

$\frac{\partial}{\partial\pi}(\int_{\Omega}fd\Omega)=\int_{\Omega}\dot{f}d\Omega+\int_{\Gamma}\left<\mathbf{n},\dot{\mathbf{x}}\right>\Delta fd\Gamma$

其中，$\dot{\mathbf{x}}:=\frac{\partial \mathbf{x}}{\partial\pi}$，这是一个$n$维的向量，表示边界相对于参数$\pi$的运动。

$\mathbf{n}$是$\mathbf{x}\in\Gamma(\pi)$的法线方向。

$\Delta f(\mathbf{x}):=\underset{\epsilon\to0^-}{lim}f(\mathbf{x}+\epsilon\mathbf{n})-\underset{\epsilon\to0^+}{lim}f(\mathbf{x}+\epsilon\mathbf{n})$

显然，我们有内部项和边界项。内部项是对被积函数中连续部分的导数；边界项则是对$n-1$维的不连续流形$\Gamma$的积分（低维不连续不影响高维求导）。为了获得微分参数对边界处微小的改变，我们将边界变化量$\Delta f$、运动速度$\dot{\mathbf{x}}$与边界法向量$\mathbf{n}$相乘，获得边界在速度投影上的变化。

现在，我们对雷诺传输定理进行离散化，可以得到：

$\int_{\Omega}\dot{f}d\Omega\approx\frac{1}{N_i}\underset{j=1}{\overset{N_i}{\sum}}\dot{f}(x_j)\\\int_{\Gamma}\left<\textbf{n},\dot{\mathbf{x}}\right>\Delta fd\Gamma\approx\frac{1}{N_b}\underset{j=1}{\overset{N_b}{\sum}}\left<\mathbf{n},\dot{\mathbf{x}}\right>\Delta f(x_j)$

---

### 与可微光栅化的联系

上述讨论的方案都建立在对光追的可微，但目前主流的光栅化可微渲染器也可以看作对边界项积分的特例。例如，OpenDR采用有限差分法计算边界项。这些可微光栅化算法虽然是对抗锯齿和边界积分的不同近似，但都不是一致且无偏的离散化方法，这会对随机梯度下降造成影响。目前对于可微光栅化和可微光追之间的联系，通常会有如下几个话题：

- 可微光追可以用于包括全局光照和局部效果在内的各种渲染效果的微分计算。

- 可见性问题并不是当前可微渲染系统的最大瓶颈，实际上，绝大多数渲染时间都用在了微分过程中无关内存读取、无规则散射和原子操作上。

- 内部积分项和边界积分项可以使用不同的可见性算法。完全可以对内部项使用可微光栅化，而对边界项使用可微光追。

- 许多可微光栅化使用的加速算法也可用在可微光追上，比如分层Z-buffer。

- 边界在图片中的像素占比实际上很低，所以在计算边界积分时，并不需要太多的采样点就可以得到误差很小的结果。

- 光线追踪也是可以硬件加速的，所以并行光追和光栅化之间的性能差距正在逐渐缩小。

---

### PBDR原理

先回顾一下渲染方程：

$L(x,\omega_o)=L_e(x,\omega_o)+\int_{\mathbb{S}^2}L_i(x,\omega_i)f_s(x,\omega_i,\omega_o)d\sigma(\omega_i)$

其中，$L_i$是入射辐射度，$f_s$是余弦加权的BSDF，$d\sigma$是立体角大小。

渲染方程是没有解析解的，所以只能使用数值解法。数值解法很多，比较著名的有无偏的单向路径追踪和双向路径追踪，有偏的光子映射等。

我们先从直接光照开始，来自于表面某点$x$处且朝向$\omega_o$方向的反射辐射度可以表述为：

$L_r(x,\omega_o)=\int_{\mathbb{S}^2}L_e(y,-\omega_i)f_s(x,\omega_i,\omega_o)d\sigma(\omega_i)$

其中，$y$是从$x$出发，向$\omega_i$方向打出的光线和表面的最近交点，也就是$y=rayTrace(x,\omega_i)$。直接光照积分是一个简单的球面积分，被积函数全部由已知量构成。

现在，我们尝试计算$L_r(x,\omega_o)$对于某个场景参数$\pi\in\mathbb{R}$的导数。

首先定义$f_{direct}(\omega_i;x,\omega_o):=L_e(y,-\omega_i)f_s(x,\omega_i,\omega_o)$，则表述为：

$[L_r(x,\omega_o)]'=\int_{\mathbb{S}^2}[f_{direct}(\omega_i;x,\omega_o)]'d\sigma(\omega_i)+\int_{\Delta\mathbb{S}^2}\left<\mathbf{n}_{\perp},\dot{\omega_i}\right>\Delta f_{direct}(\omega_i;x,\omega_o)dl(\omega_i)$

其中，$dl$是曲线长度。在该式中，内部项是在单位球面$\mathbb{S}^2$上的积分，与场景参数$\pi$无关；我们假设积分变量$\omega_i$也与场景参数$\pi$无关。边界项中，对于任意的$\omega_i\in\mathbb{S}(x,\omega_o)$，$\mathbf{n}_{\perp}(\omega_i)$是从$x$发出，在$\omega_i$方向上与单位球面相交点处切空间$\mathbb{S}^2$中垂直于不连续曲线的方向（单位向量）。

我们通常假定（余弦加权的）BSDF函数$f_s(x,\omega_i,\omega_o)$相对于$\omega_i$连续（除非BSDF非常光滑），那么被积函数$f_{direct}$的不连续性则完全来自于自发光项$L_e(y,-\omega_i)$，而自发光项的不连续性则通常是由遮蔽引起的，因此，我们可以得到：

$\Delta f_{direct}(\omega_i;x,\omega_o)=f_s(x,\omega_i,\omega_o)\Delta L_e(y,-\omega_i)$

基于上述内容，使用雷诺传输定理，我们就可以得到完整的微分渲染方程：

$[L(x,\omega_o)]'=[L_e(x,\omega_o)]'+\int_{\mathbb{S}^2}[L_i(x,\omega_i)f_s(x,\omega_i,\omega_o)]'d\sigma(\omega_i)+\int_{\Delta\mathbb{S}^2}\left<\mathbf{n}_{\perp},\dot{\omega_i}\right>f_s(x,\omega_i,\omega_o)\Delta L_i(x,\omega_i)dl(\omega_i)$

显然，这也是递归方程，和渲染方程一样没有解析解，稍后我们会讨论如何使用蒙特卡洛方法计算数值解。

现在，我们来讨论一类特殊的情况：**参与介质的可微分渲染**。

除了反射和折射外，还有一类重要的光线传播效果，也就是发生在参与介质中的光线吸收和散射。

光线的体积散射一般使用辐射度传播理论建模。辐射度传播使用能量守恒来描述参与介质中的光线传播，其核心在于辐射度传播方程（RTE）。考虑一种介质体积$\Omega\subseteq\mathbb{R}^3$具有边界$\partial\Omega$，则作用于辐射场$L$的稳态RTE的线性积分方程可以表述为：

$L=(\Kappa_T\Kappa_C+\Kappa_S)L+L^{(0)}$

其中，$\Kappa_T$表示一种对函数的映射，将函数$g:(\Omega\space\backslash\space\partial\Omega)\times\mathbb{S}^2\to\mathbb{R}_+$映射为：

$(\Kappa_T g)(x,\omega)=\int_0^D T(x',x)g(x',\omega)d\tau'$

其中，$x':=x-\tau\omega$；

$D$是从$x$出发，沿$-\omega$方向到达介质边界的距离$D=inf\{\tau\in\mathbb{R}_+:x-\tau\omega\in\partial\Omega\}$;

$T(x',x)$是$x',x$之间的透射率，也就是光线可以直接穿透$x',x$之间的部分（未被散射或吸收），可以表述为：$T(x',x)=exp(-\int_o^\tau\sigma_t(x-\tau'\omega)d\tau')$

其中，$\sigma_t$表示介质的消光系数（吸收系数+外散射系数）。
