## 1. 蒙特卡洛方法

- 蒙特卡洛方法是离散的数值求积分方法，如果均匀随机地取样积分域内的点，求出它们的数值结果，这些结果的平均值将在大数定理的作用下收敛至整体的平均值，那么就可以通过$average\times area$得到积分结果。
- 但蒙特卡洛方法的缺陷也很明显，对于非平滑函数的收敛较慢，对于高维函数的收敛很慢。
- 一种改进的方法是采用重要性采样，即非均匀地取样，然后依据取样概率修正样本贡献率，得到无偏的积分结果。
- 重要性采样的内容是这样的：
  1. 首先确定非均匀的取样方法，即构建一个$pdf$（概率密度函数）。先验的构造方法通常会先假定一个基函数，比如$pdf = kx^{2}$，由于概率密度函数必须在积分域上积分和为*1*，可以依此解出$k$的值。
  2. 使用$pdf$建立均匀取样与非均匀取样的映射关系。为了使取样点的分布符合$pdf$，则需要建立一个从均匀取样到非均匀取样的映射关系。
  3. 一种简单的方式是**接受拒绝采样**：找到$pdf$中的最大值$max$，先均匀随机地取样积分域中的一点$x$，然后再对$(0,max)$范围均匀随机取样一个值$t$，如果$t<pdf(x)$，则接受这个取样点$x$，否则拒绝这个取样点。这个方法相当于划定了一个长度为$area$、高度为$max$的均匀随机采样区域，找出那些处于$pdf$函数下方的取样点，这些取样点的分布符合$pdf$。但接受拒绝采样也有一些问题，当$pdf$的形状比较扁长时，取样点的拒绝率会很高，这会影响算法效率；一种优化方案（通常都会这么做）是找一个形状接近且方便抽样的分布函数（比如高斯分布）$q(x)$，用某个缩放系数$k$来调整$q(x)$得到$kq(x)$，使得$kq(x)$始终在$pdf$的上方，用$kq(x)$来生成取样点可以降低拒绝率。但很多情况下，$k$和$q(x)$并不好找。
  4. 虽然接受拒绝采样很容易理解，但如果$pdf$的形式是容易积分的（如初等函数），那么其对应的**$cdf$（累计分布函数）的反函数**是最合适的映射函数。$cdf^{-1}$恰好实现了从$[0,1]$到积分域的映射，且这个映射分布符合$pdf$的分布。在*Lambertian*材质的BRDF重要性采样中，常常构造使用$\frac{cos(\theta)}{\pi}$作为$pdf$，其在半球面上的积分和为*1*。
  5. 一个稍微复杂点的方式是**马尔科夫链采样**：马尔科夫链的状态转移矩阵所收敛到的稳定概率分布与初始状态的分布无关。如果已经知晓稳定概率分布$\pi(x)$所对应的状态转移概率矩阵$P$，则可以用任意分布（如均匀分布）得到的样本$\pi_{0}$作为初始状态，根据转移矩阵$P$进行条件概率转移$\pi_iP(i,j)$，当状态转移达到n次后，即可以认为采样集$(\pi_n,\pi_{n+1},...)$是符合平稳分布的样本集。寻找这样的转移矩阵$P$一般通过**Metropolis-Hastings采样**，通过任选的建议矩阵$Q$和对应的接受概率$\alpha$相乘，即可得到以目标分布$\pi$为唯一稳态分布的马尔科夫链的转移概率矩阵$P$。还有一种效率更高的构建方法，它的接受概率$\alpha$为*1*，是通过在平行于各维度的轴上进行转移，保证转移一定满足了细致平稳条件，这种方法是**Gibbs Sampling算法**。
  5. 另一种更快速的取样方法是**哈密尔顿蒙特卡洛（Hamiltonian Monte Carlo）**，它利用了哈密尔顿动力学中系统总能量不变的特性，将采样空间视作哈密尔顿相空间，设计一个合适的动力学系统，使得依据动力学系统遍历相空间得到的采样点符合目标分布。具体的设计方法则是先对概率分布$p(z)$进行重新表示，从而得到由$z和v$组成的联合分布形式$p(z,v)$。当以符合$p(z,v)$分布的方式对相空间$(z,v)$遍历采样，则可以得到目标分布$p(z)$。具体过程和实现可以参考[该文章](https://bocaiwen.github.io/Hamiltonian-Monte-Carlo.html)。
  5. 通过非均匀取样得到的样本分布是不均匀的，这意味着有些区域的样本取得多、有些区域的样本取得少。为了使得最终的积分结果无偏，需要对每个样本的权重进行修正，即乘以$\frac{1}{pdf}$。

